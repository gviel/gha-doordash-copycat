#    Trigger on push to main
#    Build the Docker image
#    Run the container
#    Test all endpoints
#    Stop and clean the container afterward

name: My First Workflow
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test-api:
    runs-on: ubuntu-latest
    env:
      API_URL: "http://localhost:8080"
      PAYLOAD_FEE: '{ "distance_km": 10.5, "weight_kg": 2.0}'
      BUILD_TAG: ""

    #steps:
    #  - name: Checkout repository
    #    uses: actions/checkout@v4 # This action clones the content of the current repo into the remote runner
    
      #- name: Setup Python
      #  uses: actions/setup-python@v5 # This action installs python (version below)
      #  with:
      #    python-version: "3.11"

      
    steps:
      #- name: Install dependencies
      #  run: |
      #    apt update && apt -y upgrade && apt -y install docker.io
        #  run: pip install -r requirements.txt # It installs all the necessary dependencies from requirements.txt

      - uses: actions/checkout@v4
      - name: Build the Docker image
        run: |
          BUILD_TAG=$(date +%s)
          docker build . -t delivery-fee-service         

      - name: Run de l'image docker
        run: |
          docker run -d -p 8080:8080 delivery-fee-service

      - name: Test API
        run: |
          set -e
          curl -sS -o /dev/null -w "%output{response.txt}" $API_URL | tee http_code.txt
          msg=$(cat response.txt)
          if [ "$msg" != "Welcome to the DoorDash Delivery Fee Service API"]; then
            echo "Wrong banner for API" >&2
            exit 1
          else
            echo "API is up and running"
          fi
      
      - name: Test calculate-fee
        run: |
          set -e
          resp=$(curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD_FEE"
            -w "%output{response_fee.txt}" $API_URL/calculate-fee)
          fee=$(echo $resp | jq -r '.delivery_fee')
          if [ "$fee" == "22.75"]; then
            echo "Test calculate-fee successful"
          else
            echo "Test failed: expected 22.75 but was $fee"
            exit 1
          fi
        


